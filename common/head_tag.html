<meta http-equiv="Content-Security-Policy" content="script-src 'unsafe-eval' 'self' https://cdn.logrocket.io https://cdn.lr-ingest.io https://stats.data.gouv.fr; worker-src 'self' blob:; frame-src 'self' blob: https://*.typeform.com; connect-src 'self' https://*.typeform.com https://*.logrocket.io https://*.lr-ingest.io https://*.logrocket.com https://stats.data.gouv.fr;">

<script src="https://cdn.lr-ingest.io/LogRocket.min.js"></script>
<script>location.href.includes('.gouv.fr') && window.LogRocket && window.LogRocket.init('ifgchv/forum-des-territoires');</script>


<script type="text/discourse-plugin" version="0.8.13">
  api.registerConnectorClass('below-site-header', 'home-banner', {
    setupComponent(args, component) {
      api.onPageChange((url, title) => {
        component.set('isHomePage', url === '/')
        component.set('isAnonymous', !api.getCurrentUser() || api.getCurrentUser().is_anonymous)
      })
    }
  })
</script>
<script type="text/x-handlebars" data-template-name="/connectors/below-site-header/home-banner">
  {{#if isHomePage}}
  <article class="home banner">
    <div class="wrap">
      <div class="text">
        <h1>Tester et bénéficier <br>des outils les plus adaptés <br>aux besoins de ma collectivité. </h1>
        <p>Ces outils, mis à disposition de l’ensemble des collectivités territoriales, 
sont construits avec les conseils d’agents et élus territoriaux volontaires.
</p>
          {{#if isAnonymous}}
            {{create-topic-button
              canCreateTopic=true
              action=(route-action "showLogin")
              disabled=false
              btnClass="btn-default"
              label="topic.create"
              canCreateTopicOnTag=true
            }}
          {{else}}
            {{create-topic-button
              canCreateTopic=true
              action=(route-action "createTopic")
              disabled=false
              btnClass="btn-default"
              label="topic.create"
              canCreateTopicOnTag=true
            }}
          {{/if}}
        </div>
      </div>
    </article>
  {{/if}}
</script>

<script type="text/discourse-plugin" version="0.8.13">
  api.registerConnectorClass('before-create-topic-button', 'create-topic-anonymous', {
    setupComponent(args, component) {
      component.set('isAnonymous', !api.getCurrentUser() || api.getCurrentUser().is_anonymous)
    }
  })
</script>
<script type="text/x-handlebars" data-template-name="/connectors/before-create-topic-button/create-topic-anonymous">
  {{#if isAnonymous}}
  {{create-topic-button
    canCreateTopic=true
    action=(route-action "showLogin")
    disabled=false
    btnClass="btn-default"
    label="topic.create"
    canCreateTopicOnTag=true
  }}
  {{/if}}
</script>

<script type="text/discourse-plugin" version="0.8.13">
  api.registerConnectorClass('below-site-header', 'category-banner', {
    setupComponent(args, component) {
      api.onPageChange((url, title) => {
        const controller = api.container.lookup('controller:navigation/category')
        const category = controller.get('category')
        component.set('category', category)
        component.set('show', /^\/c\//.test(url) && category)
        component.set('description', category?.description_excerpt && category?.description_excerpt?.replace(/(<([^>]+)>)/gi, ""))
      })
    }
  })
</script>
<script type="text/x-handlebars" data-template-name="/connectors/below-site-header/category-banner">
  {{#if show}}
  <article class="category banner" style="background-color: #{{category.color}}; color: #{{category.text_color}};}}')">
    <div class="color-filter">
      <div class="wrap" style="background-image: url('{{category.uploaded_logo.url}}')">
        <div class="text">
          <h1 class="title">{{category.name}}</h1>
          <p>
            {{description}}
          </p>
        </div>
      </div>
    </div>
  </article>
  {{/if}}
</script>


<script type="text/discourse-plugin" version="0.8.13">
  api.registerConnectorClass('top-notices', 'categories-list', {
    setupComponent(args, component) {
      api.onPageChange((url, title) => {
        const controller = api.container.lookup('controller:navigation/category')
        const category = controller.get('category')
        let categories = category ? controller.get('category').subcategories : []

        // home page
        if(url === '/') {
          categories = controller.site.categories
        }
        component.set('categories', categories)
        component.set('show', categories?.length)
      })
    }
  })
</script>
<script type="text/x-handlebars" data-template-name="/connectors/top-notices/categories-list">
  {{#if show}}
  <nav class="header-categories-list">
    <h2>Thématiques</h2>
    {{#each categories as |category|}}
      <a href="{{category.url}}" style="background-color: #{{category.color}}">
        <span></span>
        <span>{{category.name}}</span>
      </a>
    {{/each}}
  </nav>
  {{/if}}
</script>


<script type="text/discourse-plugin" version="0.8.13">
  api.registerConnectorClass('top-notices', 'breadcrumb', {
    setupComponent(args, component) {
      api.onPageChange((url, title) => {
        let controller = api.container.lookup('controller:topic')
        let topic = controller.get('model')
        let categories = []
        if (topic) {
          categories = topic.get('category')?.ancestors || []
        }
        // category page
        else {
          controller = api.container.lookup('controller:navigation/category')
          categories = controller.get('category')?.ancestors || []
        }
        component.set('categories', categories)
        component.set('topic', topic)
        component.set('show', categories?.length)
      })
    }
  })
</script>
<script type="text/x-handlebars" data-template-name="/connectors/top-notices/breadcrumb">
  {{#if show}}
  <nav class="breadcrumb">
    <a href="/">Accueil</a>
    {{#each categories as |category|}}
      <a href="{{category.url}}">
        <span>{{category.name}}</span>
      </a>
      {{/each}}
      {{#if topic}}
      <a href="{{topic.url}}">
        <span>{{topic.title}}</span>
      </a>
      {{/if}}
  </nav>
  {{/if}}
</script>

<script type="text/discourse-plugin" version="0.8.13">
/*
  // Disabled in order to have the default admin settings working properly
  const { iconNode } = require("discourse/helpers/fa-icon-node")
  const h = api.h

  api.reopenWidget("home-logo", {
    logo() {
      const assets = settings.theme_uploads
      const site = this.siteSettings
      const logoUrl = assets.logo_url || ""
      const smallLogoUrl = assets.small_logo_url || ""
      const mobileView = this.site.mobileView
      const mobileLogoUrl = assets.mobile_logo_url || ""
      const showMobileLogo = mobileView && mobileLogoUrl.length > 0
      const title = settings.title || site.title

      if (!mobileView && this.attrs.minimized) {
        if (smallLogoUrl.length) {
          return h("img#site-logo.logo-small", {
            key: "logo-small",
            attributes: { src: smallLogoUrl, width: 33, height: 33, alt: `Forum des Territoires : ${title}` }
          })
        } else {
          return iconNode("home")
        }
      } else if (showMobileLogo) {
        return h("img#site-logo.logo-big", {
          key: "logo-mobile",
          attributes: { src: mobileLogoUrl, alt: `Forum des Territoires : ${title}` }
        })
      } else if (logoUrl.length) {
        return h("img#site-logo.logo-big", {
          key: "logo-big",
          attributes: { src: logoUrl, alt: `Forum des Territoires : ${title}` }
        })
      } else {
        return h("h1#site-text-logo.text-logo", { key: "logo-text" }, `Forum des Territoires : ${title}`)
      }
    }
  })
  */
</script>
